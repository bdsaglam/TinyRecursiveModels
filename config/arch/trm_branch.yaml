# Branching TRM with Multi-Path Reasoning via Clone-Perturb-Aggregate
#
# This configuration enables the branching TRM architecture where z: [B, S, H]
# is cloned into M branches forming [B, M, S, H]. Each branch runs latent_recursion
# independently in parallel (flattened to [B*M, S, H]) to explore different solutions.
#
# Key insight: Diversity loss applied only to second half of H (H/2:H)
# - First half (0:H/2): shared problem understanding (allowed to converge)
# - Second half (H/2:H): diverse solution exploration (diversity loss applied)
#
# Algorithm:
#   z: [B, S, H] -> expand to [B, M, S, H] with perturbations
#   -> flatten to [B*M, S, H] -> latent_recursion
#   -> reshape to [B, M, S, H] -> aggregate to [B, S, H]
#
# This keeps the same interface while enabling parallel reasoning path exploration.

name: recursive_reasoning.trm_branch@BranchTRM
loss:
  name: losses@ACTLossHead
  loss_type: stablemax_cross_entropy

# Standard TRM parameters
H_cycles: 3  # T in paper (deep recursion cycles)
L_cycles: 6  # n in paper (latent recursion cycles)

H_layers: 0  # Not used
L_layers: 2  # Number of transformer layers

hidden_size: 512
num_heads: 8
expansion: 4

puzzle_emb_ndim: ${.hidden_size}
puzzle_emb_len: 16

pos_encodings: rope
forward_dtype: bfloat16

mlp_t: False  # use MLP on sequence length instead of attention

# ACT parameters
halt_max_steps: 8
halt_exploration_prob: 0.1
no_ACT_continue: True

# ============================================================================
# Multi-Branch Reasoning Configuration (via Clone-Perturb-Aggregate)
# ============================================================================

# Number of parallel reasoning branches (M)
# Set to 1 for standard TRM (baseline, no branching)
# Try 2-8 for multi-branch exploration
#
# Algorithm (key: branches evolve independently through ALL T cycles):
#   1. Initialize: z [B,S,H] -> z_branches [B,M,S,H] with perturbations on H/2:H
#   2. For T-1 cycles (no grad):
#      - Flatten: [B,M,S,H] -> [B*M,S,H]
#      - latent_recursion on all M branches in parallel
#      - Reshape: [B*M,S,H] -> [B,M,S,H] (branches stay separate!)
#   3. For 1 cycle (with grad):
#      - Same as above, branches continue independent evolution
#   4. Compute diversity loss on [B,M,S,H] (branches still separate)
#   5. Aggregate ONCE: [B,M,S,H] -> [B,S,H] via mean
#   6. Update y using aggregated z
#
# Critical: branches maintain separate trajectories through ALL T cycles,
# only aggregate at the very end for y update. This enables true parallel
# exploration without premature collapse.
num_branches: 1

# ============================================================================
# Diversity Loss Configuration
# ============================================================================

# Diversity loss type (applied to second half H/2:H only, not first half)
# Options:
#   - "none": Level 0 - No diversity loss (baseline, expect collapse)
#   - "cosine_repulsion": Level 1 - Simple pairwise cosine penalty
#   - "orthogonality": Level 1 - Matrix orthogonality constraint
#   - "repulsion_with_radius": Level 2 - Bounded diversity with radius constraint
#   - "dpp": Level 3 - Determinantal Point Process diversity (expensive)
diversity_loss_type: "none"

# Loss weights
diversity_loss_weight: 0.0  # λ_div (try 0.01-0.1 when enabling)
branch_magnitude_weight: 0.0  # λ_mag - prevents branch dims from exploding (try 0.001-0.01)

# Hyperparameters for specific diversity losses
diversity_alpha: 1.0  # Temperature for repulsion_with_radius
diversity_rho: 2.0  # Radius bound for repulsion_with_radius
diversity_epsilon: 1e-5  # Stability constant for DPP

# ============================================================================
# Example Configurations
# ============================================================================
#
# Level 0 - Baseline (no branching):
#   num_branches: 1
#   diversity_loss_type: "none"
#
# Level 1 - Simple Branching with Cosine Repulsion:
#   num_branches: 4
#   diversity_loss_type: "cosine_repulsion"
#   diversity_loss_weight: 0.01
#   branch_magnitude_weight: 0.001
#
# Level 1 - Orthogonality Constraint:
#   num_branches: 4
#   diversity_loss_type: "orthogonality"
#   diversity_loss_weight: 0.01
#   branch_magnitude_weight: 0.001
#
# Level 2 - Bounded Diversity:
#   num_branches: 4
#   diversity_loss_type: "repulsion_with_radius"
#   diversity_loss_weight: 0.01
#   branch_magnitude_weight: 0.001
#   diversity_alpha: 1.0
#   diversity_rho: 2.0
